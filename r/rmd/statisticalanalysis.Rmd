---
title: "Statistical analysis in deforestation and forest samples in Amazon Forest"
output: html_notebook
---

# Introduction

The Amazon forest is the largest rainforest in the world, and it has a vital role in the carbon cycle and climate regulation. The majority of the Amazon forest is in Brazil, about 60%. Since the end of 80 decade, the Brazilian government has maintained projects based on remote sensing images to monitor the region. PRODES, launched in 1988, is a project with global respect, and it was responsible for a considerable decrease in the deforestation rate in the 90s and the beginning of the 2000s. However, deforestation has increased over the past 15 years, which concerns the Brazilian government.

Even with the evolution of machine learning methods, the visual analysis of the images is the primary method in PRODES and other monitoring projects. For some reason, the region is covered by clouds almost all year, which can result in noise samples and a low number of images with soil information. Another reason is the variability of the samples observed in the region. The Amazon forest has a distinct response over a year and more; the forest may be different depending on the location, and this can result in multiple patterns. Also, deforestation only occurs occasionally, presenting distinct patterns to samples. So, a machine learning method to produce information can be complex. 

Considering the sampling process in machine learning methods, understanding how samples behave spatial and temporal is fundamental to improving the results of machine learning methods. So, this work aims to produce a statistical analysis of samples of deforestation and forest in the Amazon forest to understand how much the patterns are different in the deforest and forest classes.


# Statistical Analysis

Statistical analysis is a mathematical procedure to investigate trends, patterns and relationship through quantitative data. The method consists in collect data and summarize it using a descriptive statistics. To draw a valid conclusions using statistical analysis is important develop carefully the sampling procedure, use inferential statistics to test hypotheses, make estimates about the population to finally interpret and generalize your findings.

## Hypotheses
* General
  + Can use short time series to improve the generalization of model?
  + Is there a relationship between samples in different region and time?
  
* Spatial 
  + Samples in different tile can be classify using an single tile as reference. 
  + The patterns are similar in different tiles.
  + Is possible produce a ML model generic as possible to classify different region?
* Temporal
  + Samples in a specific time step can be used to classify samples in the future
  + The seasonal behavior of time series happen in the next years

  
  
# Statistics

The samples using a PRODES map to define their geographic location (longitude and latitude) and S2_SEN2COR_10_16D_STK-1 BDC cube provide the time series values. PRODES methodology allows us to define forest samples where it is possible to define a single class sample over two consecutive years safely. Considering deforestation areas, it is impossible to ensure a single class sample over these two years because the land cover can change along the selected period, e.g., pasture. However, it is possible to conclude that there was deforestation at the beginning of the time series period, and the ground truth is not a primary forest in all periods. The samples have 77636 time series: 64561  in forest and 28668 deforested areas. The R code above imports the samples and the first six samples.

```{r}
getwd()
```

```{r}
samples <- readRDS("../../data/rds/samples.rds")
head(samples)
```

# General Analysis

The statistic analysis can allow us to understand the temporal and spatial behavior of the samples, showing patterns, trends, relationships, and variability using quantitative data. We will start presenting a summary of the bands' values by class. The data comprises sentinel observations, including twelve bands and two vegetation indexes. The code above summarizes the time series data along the time by class. In this summary, we can visualize basic statistical measurements for each band by class.

* Forest samples

```{r}
forest_samples <- samples[samples$label == "Forest",]
ts <- forest_samples$time_series
dt <- dt <- data.table::data.table(dplyr::bind_rows(ts))
summary(dt)
```
2,591  6,705
* Deforestation samples 
 
```{r}
deforestation_samples <- samples[samples$label == "Deforestation",]
ts <- deforestation_samples$time_series
dt <- dt <- data.table::data.table(dplyr::bind_rows(ts))
summary(dt)
```
 
To all values, we can observe a distortion between the median/mean and the maximum and maximum value measured for both the deforestation and the forest class. In this summary, the measures consider all values independent of the date, so we do not consider the temporal characteristic of the samples. These distortions can indicate that the observed value can not correspond to the actual land cover value at some point in the period. Some reasons for this can be the presence of clouds,  aerosol interference, or pixel saturation. The interquartile range shows slight variation, indicating that most observed values have a singular pattern. 

# Variation band

Above is presented a box plot for each band.  
 
```{r}
plot_box(samples)
```

The interquartile variation is generally more significant for the Deforestation class than the Forest class, showing that the forest class presented a more homogeneous behavior. This behavior is 
expected considering the characteristics of the classes. The Amazon forest presents a massive tree concentration throughout the entire period. Meanwhile, deforestation is a non-homogeneous tree loss that can explain the variation, and the area can be another class, e.g., pasture. Still looking for the interquartile, the band variation is slight to all bands and slightly more significant to indexes. The bands B01 to B05 presented a slight variation considering the two classes. Contrasting Forest against Deforestation class, the band B12 to Forest class also presents a slight variation; meanwhile, the band B12 to Deforestation class presents more variation in comparison. The bands B06 to B11 present more variation in contrast to other bands. The indexes' variation is more considerable, mainly considering the deforestation class. The median for the bands presents less variation to the classes compared to indexes; this shows how these indexes highlight the vegetation. All bands presented many numbers of outliers. To analyze these behaviors, we will explore the temporal characteristics to verify if these observations can be retired or if these outliers represent a natural variation considering clouds, for example.


Now, we are analyzing the behavior of the bands, considering the time variation. To simplify the visualization of the charts, we analyzed the two indexes (NDVI and EVI). Above, we plot two charts of the median and the quartiles. The command above calculated some statistics from the sample data: Mean, Median, Quartil 25%, Quartil 75%, Median, Standard deviation, and Correlation.

```{r}
stats <- stats_ts(samples)
```

* NDVI and EVI (Plotting Median and Quartils)

```{r}
plot_stats(stats, c("Median", "Q25", "Q75"), c("NDVI", "EVI"))
```

Analyzing the graphs, we can observe that the forest samples present a behavior with less variation in the median value over time than the deforestation class. The interquartile range for deforestation samples is generally considerably more extensive than for forest samples. In addition, the interquartile distance is more diminutive in periods of drought, indicating that the lower presence of clouds in this period drastically reduces the variability of observed values. The median of the indices for the deforestation samples presents two characteristic peaks in the rainy season and two valleys in the dry season. As for the forest samples, it is also possible to identify these peaks and valleys for the same periods. However, the values have a lower variance, highlighting the more homogeneous behavior for the vegetation indices over time. By contrasting the indices, we can see that
in the case of deforestation samples, the general behavior of the median is similar for both indices, with lower values for EVI and higher values for NDVI. As for the forest samples, we can identify an almost opposite behavior for the indices. When the value increases for the EVI, the median value decreases for the NDVI. 

# Patern analysis

In time series analysis, it is helpful to visualize the temporal patterns to understand the band variability over the period. The chart above presents a statistical approximation of the samples in a single plot with all available sentinel bands and two vegetation indexes. The patterns represent an additive model (GAM) to obtain a possible predictor.

The following code presents the function sits_patterns(). It uses the dtwSat R package to generate the patterns used in the plot.


```{r}
patterns <- sits_patterns(samples)
plot_patterns(patterns)
  
```

The resulting patterns allow us to analyze the behavior of the deforestation and Forest classes over two years of observations. The Forest class has less variation response than deforestation over the years; this shows that it should be possible to generate a reasonable separation between the classes. We can gain some insights into the expected classes by considering the vegetation indexes. The forest response is more homogeneous over the period with high values than the deforestation class, where the responses present high variation. Deforestation is the highest response occurring in the rainy season, with a considerable drop in the dry season. Contrasting the indexes, the deforestation response to NDVI and EVI presents a solid linear positive correlation. For the forest response, there is no strong linear correlation between the indexes.

#Intra-class band Correlation

The previous patterns are sound indicative of the class's behavior. Thus, their Correlation can support the previous analysis. The code below calculates the intra-class band correlation and plots it. Here, we desire to analyze numerically the relationship between the pattern bands of deforestation and Forest classes separately.

```{r}
cor <- corr_ts(patterns)
plot_corr_matrix(cor)
  
```
The intra-class Correlation of the band's patterns to forest patterns reveals a high correlation to all bands except the NDVI band. In the deforestation class, we can separate four groups with a  high correlation: B01 to B05, B06 to B09, B11 to B12, and NDVI and EVI. 




The code below calculates the inter-class band correlation and plots it. Here, we want to analyze the band patterns correlation class by class,  comparing deforestation bands with forest bands.

```{r}
df <- corr_classes(patterns)

ggplot(data=df, aes(x=Band, y=Correlation)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=Correlation), vjust=-0.3, size=3.5)+
  theme_minimal()

```


# Bands Analysis


